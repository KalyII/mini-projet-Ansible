---
- name: Deploy Webserver
  hosts: webservers
  become: true

  vars:
    nginx_root_location: "/usr/share/nginx/html"

  tasks:

    ### 1. DÃ©tecter la famille OS
    - name: Set nginx root for RedHat
      set_fact:
        nginx_root_location: "/usr/share/nginx/html"
      when: ansible_os_family == "RedHat"

    - name: Set nginx root for Debian
      set_fact:
        nginx_root_location: "/var/www/html"
      when: ansible_os_family == "Debian"


    ### 2. Installer EPEL (CentOS)
    - name: Install EPEL repository
      yum:
        name: epel-release
        state: present
      when: ansible_os_family == "RedHat"


    ### 3. Ajouter dÃ©pÃ´t officiel Nginx (CentOS)
    - name: Add official Nginx repository
      yum_repository:
        name: nginx-stable
        description: nginx stable repo
        baseurl: http://nginx.org/packages/centos/$releasever/$basearch/
        gpgcheck: no
        enabled: yes
      when: ansible_os_family == "RedHat"


    ### 4. Installer nginx
    - name: Install nginx
      yum:
        name: nginx
        state: latest
      when: ansible_os_family == "RedHat"


    ### 5. Stop any running nginx (sans erreur)
    - name: Kill any running nginx
      shell: pkill -f nginx
      failed_when: false   # ðŸ”¥ empÃªche l'erreur inutile
      ignore_errors: yes   # ðŸ”¥ accepte pkill mÃªme si nginx n'est pas lancÃ©


    ### 6. Start nginx manuellement
    - name: Start nginx manually
      shell: nginx
      failed_when: false


    ### 7. Enable nginx au boot (CentOS)
    - name: Enable nginx at boot (rc.local hack)
      shell: echo "nginx" >> /etc/rc.local
      args:
        executable: /bin/bash
      when: ansible_os_family == "RedHat"


    ### 8. DÃ©ployer index.html (depuis templates/)
    - name: Deploy index.html
      template:
        src: index.html-easter_egg.j2
        dest: "{{ nginx_root_location }}/index.html"
        mode: 0644


    ### 9. Installer unzip
    - name: Install unzip
      package:
        name: unzip
        state: latest


    ### 10. Extraire le jeu stacker
    - name: Extract stacker game
      unarchive:
        src: "files/playbook_stacker.zip"   # ðŸ”¥ chemin CORRIGÃ‰
        dest: "{{ nginx_root_location }}"
        remote_src: no
        mode: 0755


